/*! triviaJS 2014-02-20 */
(function(a){a.widget("ign.trivia",{width:0,height:0,roundPoints:0,questionStartTime:0,questionEndTime:0,options:{questions:[],hiScore:"0000",tiempoLimite:10,questionsPerGame:10,labels:{hiScore:"TOP: ",title:"GeoTrivia",playerScore:"PUNTOS: ",preguntasUrl:""}},_create:function(){},_init:function(){this.element.css({position:"relative"});this.width=this.element.innerWidth();this.height=this.element.innerHeight();var b=this;this._setUpGameSpace();this._setupSlideshow();a.when(this._loadQuestions()).then(function(a){if(a["preguntas"]===undefined){b._showError('no se encontro el item "preguntas"');return false}b.options.questions=a["preguntas"].slice();b._showStartSplash()},function(){if(b.options.questions["preguntas"]===undefined){b._showError("no se pudo cargar el archivo de preguntas y no se suministraron preguntas")}})},_loadQuestions:function(b){var c=this;var d=a.Deferred(function(b){a.getJSON(c.options.preguntasUrl).then(b.resolve,b.reject)}).promise();return d.done(b)},startGame:function(){this.slideShow.pause();this.roundQuestions=[];this.preguntaActual=null;this.roundPoints=0;var b=this;var c=this.options.questions.slice();var d;for(var e=0;e<this.options.questionsPerGame;e++){d=Math.random()*c.length<<0;this.roundQuestions.push(c.splice(d,1)[0])}TweenMax.to(this.startSplash,.5,{autoAlpha:0,scale:.1,ease:Back.easeIn,onComplete:a.proxy(this._showQuestion,b)})},_showEndSplash:function(){var b=this;var c={points:0};var d=a(".finalScore",this.endSplash);var e=new TimelineMax({onComplete:function(){b.endSplash.on("click",function(){b.endSplash.off("click");b._showStartSplash()})}});e.add(TweenMax.to(this.endSplash,.25,{autoAlpha:1}));e.add(TweenMax.to(c,3,{points:this.roundPoints,onUpdate:function(){d.text(c.points<<0)}}))},_showQuestion:function(){if(this.roundQuestions.length===0){this._showEndSplash();return}var b=this;var c=Math.random()*this.roundQuestions.length<<0;this.preguntaActual=this.roundQuestions.splice(c,1)[0];TweenMax.set([this.questionLabel,this.respuesta1,this.respuesta2,this.respuesta3],{autoAlpha:1,scale:1});var d=this._mezclarArray(this.preguntaActual.opciones);this.respuesta1.find("p").first().text(d[0]);this.respuesta2.find("p").first().text(d[1]);this.respuesta3.find("p").first().text(d[2]);this.questionLabel.text("#"+String(b.options.questionsPerGame-b.roundQuestions.length));this.questionBox.find("#consigna").first().text(this.preguntaActual.consigna);var e=function(){b._processResponse(a(this).find("p").first().text())};var f=function(){b.respuesta1.on("click",e);b.respuesta2.on("click",e);b.respuesta3.on("click",e);b.questionStartTime=new Date};var g=new TimelineMax({onComplete:f});g.add(TweenMax.from(this.questionLabel,1.5,{delay:.25,autoAlpha:0,scale:3,ease:Power4.easeIn}));g.add(TweenMax.to(this.background,.5,{yoyo:true,repeat:1,autoAlpha:0,onRepeat:function(){b.background.attr("src","images/fondos/"+b.preguntaActual.id+".jpg")}}));g.add(TweenMax.to(this.questionBox,.75,{delay:.25,autoAlpha:1}));g.add(TweenMax.staggerFrom([this.respuesta1,this.respuesta2,this.respuesta3],.25,{autoAlpha:0,scale:.2,ease:Back.easeOut,delay:1},.15))},_processResponse:function(b){this.questionEndTime=new Date;this.respuesta1.off("click");this.respuesta2.off("click");this.respuesta3.off("click");var c=this;var d=b===this.preguntaActual.respuesta;var e=this.questionEndTime-this.questionStartTime;var f=this.options.tiempoLimite*1e3-e;if(f<0||!d){f=0}this.roundPoints+=f;this.responseSplash.find("p.calificacion").first().text(d?"CORRECTO!":"INCORRECTO!");this.responseSplash.find("p.remate").first().text(this.preguntaActual.remate);var g=a(".roundUpLabel",this.roundUpDiv);var h=a(".roundUpScore",this.roundUpDiv);var i=a(".cta",this.responseSplash);g.text("Puntos por esta respuesta: ");h.text("0");TweenMax.set(this.responseSplash,{autoAlpha:1,scale:1});var j=function(){c.responseSplash.on("click",function(){c.responseSplash.off("click");TweenMax.to(c.responseSplash,.5,{autoAlpha:0,scale:.1,ease:Back.easeIn,onComplete:a.proxy(c._showQuestion,c)})})};var k=new TimelineMax({onComplete:j});k.add(TweenMax.staggerTo([this.questionBox,this.questionLabel,this.respuesta1,this.respuesta2,this.respuesta3],.2,{autoAlpha:0},.1));k.add(TweenMax.from(this.responseSplash,.5,{y:-1e3,autoAlpha:0,ease:Back.easeOut}));k.add(TweenMax.set(this.roundUpDiv,{autoAlpha:1}));k.add(TweenMax.staggerFrom([g,h],.25,{autoAlpha:0,x:"+=100"},.25),"+=1.5");if(f>0){var l={points:0};k.add(TweenMax.to(l,3,{points:f,onUpdate:function(){h.text(l.points<<0)}}))}k.add(TweenMax.from(i,.25,{autoAlpha:0}),"+=0.25")},_mezclarArray:function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c){}return a},_showStartSplash:function(){this.slideShow.resume();TweenMax.staggerTo([this.endSplash,this.respuesta1,this.respuesta2,this.respuesta3,this.responseSplash],.5,{autoAlpha:0});TweenMax.set(this.startSplash,{scale:1,autoAlpha:0});TweenMax.to(this.startSplash,.5,{autoAlpha:1})},_zOrder:function(a){for(var b=0;b<a.length;b++){a[b].css("z-index",b+20)}},_setupSlideshow:function(){var a=this;this.slideShow=new TweenMax.to({id:0,v:0},5,{v:1,onRepeatParams:[this.background],onRepeat:function(a){var b=(Math.random()*50<<0)+1;TweenMax.to(a,.5,{alpha:0,yoyo:true,repeat:1,onRepeat:function(){a.attr("src","images/fondos/"+b+".jpg")}})},repeat:-1})},_setUpGameSpace:function(){var b=this;this.gameSpace=a("#gameSpace",this.element);this.background=a("#background",this.gameSpace);this.questionBox=a("#questionBox",this.gameSpace);this.questionLabel=a("#questionLabel > #numeroPregunta",this.gameSpace);this.respuesta1=a("#opcion1",this.gameSpace);this.respuesta2=a("#opcion2",this.gameSpace);this.respuesta3=a("#opcion3",this.gameSpace);this.responseSplash=a("#responseSplash",this.gameSpace);this.startSplash=a("#startSplash",this.gameSpace);this.endSplash=a("#endSplash",this.gameSpace);this.errorSplash=a("#errorSplash",this.gameSpace);this.errorSplash.message=a("p",this.errorSplash);this.startSplash.click(function(a){b.startGame();return false});this.roundUpDiv=a(".roundUp",this.responseSplash);this.questionBox.outerWidth(this.width);this._center(this.errorSplash,this.element);this._center(this.questionLabel,null,true);TweenMax.set([this.endSplash,this.startSplash,this.questionLabel,this.questionBox,this.respuesta1,this.respuesta2,this.respuesta3,this.responseSplash,this.errorSplash],{autoAlpha:0})},_crearEspacioDeJuego:function(){var b=this;this.gameSpace=a('<div id="gameSpace" />').appendTo(this.element);this.questionBox=a('<div id="questionBox" />').appendTo(this.gameSpace);this.questionLabel=a('<div id="questionLabel" />').appendTo(this.gameSpace);this.respuesta1=a('<div class="respuesta opcion1" data-index="0" />').appendTo(this.gameSpace);this.respuesta2=a('<div class="respuesta opcion2" data-index="1" />').appendTo(this.gameSpace);this.respuesta3=a('<div class="respuesta opcion3" data-index="2" />').appendTo(this.gameSpace);this.responseSplash=a('<div id="responseSplash" />').appendTo(this.gameSpace);this.startSplash=a('<div id="startSplash" />').html("<h1>Trivia IGN</h1>").appendTo(this.element);this.startButton=a('<a href="#">Comenzar</a>').click(function(a){b.startGame();return false}).appendTo(this.startSplash);this.endSplash=a('<div id="endSplash" />').appendTo(this.element);this.errorSplash=a('<div id="errorSplash" />').css({border:"2px solid yellow",position:"absolute",background:"red",width:"50%",height:"50%","text-align":"center","font-size":"20px",color:"white"}).appendTo(this.element).append(a("<h1>ERROR!</h1>"));this.errorSplash.message=a("<p />").appendTo(this.errorSplash);this._center(this.element,this.errorSplash);this._center(null,this.questionLabel,true);TweenMax.set([this.endSplash,this.startSplash,this.questionLabel,this.questionBox,this.respuesta1,this.respuesta2,this.respuesta3,this.responseSplash,this.errorSplash],{autoAlpha:0})},_showError:function(a){console.log("error: "+a);this.errorSplash.message.text(a);TweenMax.set(this.errorSplash,{autoAlpha:1})},_center:function(a,b,c){if(b===null||b===undefined){b=a.parent()}var d={top:c?a.offset().top:(b.innerHeight()-a.outerHeight())/2,left:(b.innerWidth()-a.outerWidth())/2};a.offset(d)},_crearBarraInfo:function(){this.statusBar=a('<div id="statusBar" />').css({background:"black",color:"white","font-family":"Courier New, sans"});this.hiScoreLabel=a('<div class="label" />').text(this.options.labels.hiScore).css({width:"30%","margin-left":"2%"}).appendTo(this.statusBar);this.hiScoreValue=a('<span class="hiScore" />').text(this.options.hiScore).css("color","yellow").appendTo(this.hiScoreLabel);this.gameTitle=a('<div class="title" />').text(this.options.labels.title).css({width:"36%","text-align":"center"}).appendTo(this.statusBar);this.scoreLabel=a('<div class="label" />').text(this.options.labels.playerScore).css({display:"inline-block",width:"30%","text-align":"right","margin-right":"2%"}).appendTo(this.statusBar);this.scoreValue=a('<span class="playerScore" />').text("0000").css({color:"yellow"}).appendTo(this.scoreLabel);this.statusBar.appendTo(this.element)}})})(jQuery);